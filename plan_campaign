# ------------------------------
# ğŸ“… ØµÙØ­Ø© ØªØ®Ø·ÙŠØ· Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
# ------------------------------
def plan_campaign():
    st.markdown("<h2>ğŸ“… ØªØ®Ø·ÙŠØ· Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>", unsafe_allow_html=True)

    # ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
    try:
        with open("campaign_plans.json", "r", encoding="utf-8") as f:
            campaigns = json.load(f)
    except FileNotFoundError:
        campaigns = []

    # ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
    try:
        with open("campaign_logs.json", "r", encoding="utf-8") as f:
            campaign_logs = json.load(f)
    except FileNotFoundError:
        campaign_logs = []

    # Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ø­Ù…Ù„Ø©
    st.subheader("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª")
    campaign_names = [c["name"] for c in campaigns]
    campaign_action = st.radio("Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:", ["Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©", "ØªØ¹Ø¯ÙŠÙ„ Ø­Ù…Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©"], horizontal=True)

    if campaign_action == "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©":
        name = st.text_input("Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©:")
        col1, col2 = st.columns(2)
        with col1:
            start_date = st.date_input("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©")
        with col2:
            end_date = st.date_input("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©")
        campaign_type = st.selectbox("Ù†ÙˆØ¹ Ø§Ù„Ø­Ù…Ù„Ø©:", ["Ø¹Ø±ÙˆØ¶ Ù…ÙˆØ³Ù…ÙŠØ©", "Ø¹Ø±ÙˆØ¶ Ø¬Ø¯ÙŠØ¯Ø©", "Ø±Ù…Ø¶Ø§Ù†", "Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡", "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù…"])
        target_market = st.text_input("Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŒ Ø§Ù„ÙƒÙˆÙŠØª...)")
        goal = st.text_area("Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ø­Ù…Ù„Ø©:")

        if st.button("ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©", use_container_width=True):
            if name:
                new_campaign = {
                    "name": name,
                    "created_by": st.session_state.user,
                    "created_at": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    "start_date": str(start_date),
                    "end_date": str(end_date),
                    "type": campaign_type,
                    "market": target_market,
                    "goal": goal,
                    "products": []
                }
                campaigns.append(new_campaign)
                with open("campaign_plans.json", "w", encoding="utf-8") as f:
                    json.dump(campaigns, f, ensure_ascii=False, indent=2)

                # Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                campaign_logs.append({
                    "campaign": name,
                    "user": st.session_state.user,
                    "action": "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©",
                    "timestamp": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    "details": f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³Ù… {name}"
                })
                with open("campaign_logs.json", "w", encoding="utf-8") as f:
                    json.dump(campaign_logs, f, ensure_ascii=False, indent=2)
                st.success(f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© ({name}) Ø¨Ù†Ø¬Ø§Ø­ âœ…")
                st.rerun()
            else:
                st.warning("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.")

    elif campaign_action == "ØªØ¹Ø¯ÙŠÙ„ Ø­Ù…Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©":
        if not campaign_names:
            st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.")
            return
        selected_campaign = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ø­Ù…Ù„Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§:", campaign_names)
        campaign = next(c for c in campaigns if c["name"] == selected_campaign)

        # Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        st.subheader("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©")
        st.write(f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø©: {campaign['created_by']} Ø¨ØªØ§Ø±ÙŠØ® {campaign['created_at']}")

        col1, col2 = st.columns(2)
        with col1:
            campaign["start_date"] = st.date_input("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", datetime.datetime.strptime(campaign["start_date"], "%Y-%m-%d").date())
        with col2:
            campaign["end_date"] = st.date_input("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", datetime.datetime.strptime(campaign["end_date"], "%Y-%m-%d").date())
        campaign["goal"] = st.text_area("Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ø­Ù…Ù„Ø©:", campaign["goal"])
        campaign["market"] = st.text_input("Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:", campaign["market"])
        campaign["type"] = st.selectbox("Ù†ÙˆØ¹ Ø§Ù„Ø­Ù…Ù„Ø©:", ["Ø¹Ø±ÙˆØ¶ Ù…ÙˆØ³Ù…ÙŠØ©", "Ø¹Ø±ÙˆØ¶ Ø¬Ø¯ÙŠØ¯Ø©", "Ø±Ù…Ø¶Ø§Ù†", "Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡", "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù…"], index=["Ø¹Ø±ÙˆØ¶ Ù…ÙˆØ³Ù…ÙŠØ©", "Ø¹Ø±ÙˆØ¶ Ø¬Ø¯ÙŠØ¯Ø©", "Ø±Ù…Ø¶Ø§Ù†", "Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡", "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù…"].index(campaign["type"]))

        st.markdown("---")
        st.subheader("Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø­Ù…Ù„Ø©")

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if campaign["products"]:
            for i, p in enumerate(campaign["products"]):
                with st.expander(f"Ø§Ù„Ù…Ù†ØªØ¬ {i+1}: {p['name']}"):
                    p["name"] = st.text_input(f"Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ {i+1}:", value=p["name"], key=f"name_{i}")
                    p["offer"] = st.text_input(f"Ø§Ù„Ø¹Ø±Ø¶ {i+1}:", value=p["offer"], key=f"offer_{i}")
                    p["price_before"] = st.number_input(f"Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ… {i+1}:", value=p["price_before"], key=f"before_{i}")
                    p["price_after"] = st.number_input(f"Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… {i+1}:", value=p["price_after"], key=f"after_{i}")
                    p["platform"] = st.selectbox(f"Ø§Ù„Ù…Ù†ØµØ© {i+1}:", ["Snapchat", "TikTok", "Meta"], key=f"platform_{i}")
                    p["status"] = st.selectbox(f"Ø§Ù„Ø­Ø§Ù„Ø© {i+1}:", ["Ù†Ø´Ø·", "Ù…ÙˆÙ‚ÙˆÙ"], key=f"status_{i}")
                    if st.button(f"ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ {i+1}", key=f"delete_{i}"):
                        campaign["products"].pop(i)
                        st.experimental_rerun()

        # Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
        with st.expander("â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯"):
            new_name = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:")
            new_offer = st.text_input("Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶:")
            new_price_before = st.number_input("Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:", 0)
            new_price_after = st.number_input("Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:", 0)
            new_platform = st.selectbox("Ø§Ù„Ù…Ù†ØµØ©:", ["Snapchat", "TikTok", "Meta"])
            if st.button("Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬"):
                campaign["products"].append({
                    "name": new_name,
                    "offer": new_offer,
                    "price_before": new_price_before,
                    "price_after": new_price_after,
                    "platform": new_platform,
                    "status": "Ù†Ø´Ø·"
                })
                campaign_logs.append({
                    "campaign": selected_campaign,
                    "user": st.session_state.user,
                    "action": "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬",
                    "timestamp": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    "details": f"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ {new_name}"
                })
                with open("campaign_logs.json", "w", encoding="utf-8") as f:
                    json.dump(campaign_logs, f, ensure_ascii=False, indent=2)
                st.success("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­ âœ…")
                st.rerun()

        if st.button("ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª", use_container_width=True):
            for i, c in enumerate(campaigns):
                if c["name"] == selected_campaign:
                    campaigns[i] = campaign
            with open("campaign_plans.json", "w", encoding="utf-8") as f:
                json.dump(campaigns, f, ensure_ascii=False, indent=2)

            campaign_logs.append({
                "campaign": selected_campaign,
                "user": st.session_state.user,
                "action": "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø©",
                "timestamp": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "details": "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø© ÙˆÙ…Ø­ØªÙˆØ§Ù‡Ø§"
            })
            with open("campaign_logs.json", "w", encoding="utf-8") as f:
                json.dump(campaign_logs, f, ensure_ascii=False, indent=2)
            st.success("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…")

        # Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        st.markdown("---")
        st.subheader("Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª")
        log_df = pd.DataFrame([l for l in campaign_logs if l["campaign"] == selected_campaign])
        if not log_df.empty:
            st.dataframe(log_df[["timestamp", "user", "action", "details"]], use_container_width=True)
        else:
            st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯.")
